# 插件架构

## 目录结构

+ bin
    + DiffScope.exe
    + Qt5Core.dll
    + ...
+ lib
    + DiffScope
        + plugins
            + coreplugin
                + main.dll
                + plugin.json
            + plugin2
                + ...
            + plugins.json
+ share
    + qtdummy
        + ...
    + DiffScope
        + ...

## 需要修改的部分

+ 程序启动时，先遍历`plugins`目录获取所有子目录建立子目录列表，再读取`plugins.json`建立已索引的插件列表，比较这两个列表
    1. 子目录存在，但`plugins.json`中不存在
        + 说明插件是复制过来的，还未建立索引
        + 按照`DisabledByDefault`或`Required`字段决定是否加载，并添加此插件到`plugins.json`中
    2. 子目录不存在，但`plugins.json`中存在
        + 说明插件被删除，移除本条索引
    3. 子目录存在，`plugins.json`也存在
        + 按照`plugins.json`中指定的`Enabled`属性决定是否加载

+ 将插件构建时需要的`Metadata`改为文件系统中同目录下的`plugin.json`

+ 插件加载前，在`Windows`平台中，调用`SetDllDirectoryW`保证它依赖的同目录下的动态库能正常加载

## 格式标准

### plugins.json

```json
{
    "plugins": {
        "coreplugin": {
            "enabled": true
        },
        "plugin2" : {
            "enabled": false
        }
    }
}
```

### plugin.json

```json
{
    "plugin": "coreplugin"
}
```